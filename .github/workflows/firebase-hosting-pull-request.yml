# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR
'on': pull_request
jobs:
  build_and_preview:
    if: '${{ github.event.pull_request.head.repo.full_name == github.repository }}'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: npm install
        run: npm ci

      - name: nx Install
        run: npm install -g nx --silent

      - name: Get affected apps
        run: echo "apps=$(nx affected:apps --plain --base=HEAD~1 --head=HEAD)" >> $GITHUB_OUTPUT
        id: affected-apps

      - name: Build captainofbass.com
        run: nx build captainofbass.com
        if: contains(steps.affected-apps.outputs.apps, 'captainofbass.com')

      - name: Deploy capainofbass.com
        uses: FirebaseExtended/action-hosting-deploy@v0
        if: contains(steps.affected-apps.outputs.apps, 'captainofbass.com')
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_THECAPTAIN_31E80 }}'
          projectId: thecaptain-31e80
          entryPoint: packages/captainofbass.com/firebase.json

      - name: Build members.captainssounds.com
        run: nx build members.captainssounds.com
        if: contains(steps.affected-apps.outputs.apps, 'members.captainssounds.com')

      - name: Deploy members.captainssounds.com
        uses: FirebaseExtended/action-hosting-deploy@v0
        if: contains(steps.affected-apps.outputs.apps, 'members.captainssounds.com')
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_CAPTAINS_SOUNDS_MEMBERS }}'
          projectId: captains-sounds-members
          entryPoint: packages/members.captainssounds.com/firebase.json
