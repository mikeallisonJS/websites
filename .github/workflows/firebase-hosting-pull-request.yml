# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR
'on': pull_request
jobs:
  build_and_preview:
    if: '${{ github.event.pull_request.head.repo.full_name == github.repository }}'
    env:
      NX_BRANCH: ${{ secrets.NX_BRANCH}}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: npm install
        run: npm ci

      - name: nx Install
        run: npm install -g nx --silent

      - name: Get affected apps
        run: |
          echo "apps=$(npx ts-node scripts/affected-apps.ts --projects packages/* --base=origin/main --head=HEAD)" >> $GITHUB_OUTPUT
          cat $GITHUB_OUTPUT
        id: affected-apps

      - name: Build affected apps
        uses: mansagroup/nrwl-nx-action@v3
        with:
          targets: build
          nxCloud: true
          args: --c=production

      - name: Deploy members.captainssounds.com
        uses: FirebaseExtended/action-hosting-deploy@v0
        if: contains(steps.affected-apps.outputs.apps, 'members.captainssounds.com')
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_CAPTAINS_SOUNDS_MEMBERS }}'
          projectId: captains-sounds-members
          entryPoint: packages/members.captainssounds.com

      - name: Deploy offer.captainssounds.com
        uses: FirebaseExtended/action-hosting-deploy@v0
        if: contains(steps.affected-apps.outputs.apps, 'offer.captainssounds.com')
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_CAPTAINS_SOUNDS_OFFER }}'
          projectId: offer-captainssounds-com
          entryPoint: packages/offer.captainssounds.com
